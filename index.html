<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>班級小管家 2.8</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="班級小管家">
    <meta name="theme-color" content="#FEF9F2">
    
    <link rel="apple-touch-icon" id="ios-icon" href="">
    <link rel="icon" id="fav-icon" href="">

    <!-- Dynamic Favicon Generation -->
    <script>
        window.onload = function() {
            try {
                var canvas = document.createElement('canvas');
                canvas.width = 512; canvas.height = 512;
                var ctx = canvas.getContext('2d');
                
                // 1. Background (Warm Sunny Yellow)
                ctx.fillStyle = '#FFE082'; 
                ctx.fillRect(0, 0, 512, 512);
                
                // 2. Ears (Dark Brown)
                ctx.fillStyle = '#8D6E63';
                ctx.beginPath(); ctx.arc(110, 130, 70, 0, Math.PI * 2); ctx.fill(); // Left Ear
                ctx.beginPath(); ctx.arc(402, 130, 70, 0, Math.PI * 2); ctx.fill(); // Right Ear
                
                // 3. Head (Main Brown)
                ctx.fillStyle = '#A1887F';
                ctx.beginPath(); ctx.arc(256, 276, 210, 0, Math.PI * 2); ctx.fill();
                
                // 4. Snout (Light Cream)
                ctx.fillStyle = '#EFEBE9';
                ctx.beginPath(); ctx.ellipse(256, 340, 90, 70, 0, 0, Math.PI * 2); ctx.fill();
                
                // 5. Nose (Dark Chocolate)
                ctx.fillStyle = '#3E2723';
                ctx.beginPath(); ctx.ellipse(256, 315, 35, 25, 0, 0, Math.PI * 2); ctx.fill();
                
                // 6. Eyes (Cute Dots)
                ctx.fillStyle = '#3E2723';
                ctx.beginPath(); ctx.arc(180, 240, 22, 0, Math.PI * 2); ctx.fill(); // Left Eye
                ctx.beginPath(); ctx.arc(332, 240, 22, 0, Math.PI * 2); ctx.fill(); // Right Eye
                
                // 7. Blush (Pink Cheeks)
                ctx.fillStyle = 'rgba(255, 171, 145, 0.6)';
                ctx.beginPath(); ctx.arc(130, 320, 30, 0, Math.PI * 2); ctx.fill();
                ctx.beginPath(); ctx.arc(382, 320, 30, 0, Math.PI * 2); ctx.fill();

                // 8. Mouth
                ctx.strokeStyle = '#3E2723'; ctx.lineWidth = 12; ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(256, 340); ctx.lineTo(256, 370); ctx.stroke(); // Vertical line
                ctx.beginPath(); ctx.moveTo(226, 370); ctx.quadraticCurveTo(256, 395, 286, 370); ctx.stroke(); // Smile

                var iconUrl = canvas.toDataURL('image/png');
                var iosLink = document.getElementById('ios-icon');
                var favLink = document.getElementById('fav-icon');
                if(iosLink) iosLink.href = iconUrl;
                if(favLink) favLink.href = iconUrl;
            } catch (e) { console.warn("Icon failed", e); }
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap');

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            background-color: #FEF9F2; 
            margin: 0; 
            padding: 0; 
            overscroll-behavior-y: none; 
            font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
            color: #5D4037;
            background-image: linear-gradient(#E8E8E8 1px, transparent 1px), linear-gradient(90deg, #E8E8E8 1px, transparent 1px); 
            background-size: 20px 20px;
        }
        
        /* Custom UI Components */
        .btn-3d { 
            transition: all 0.1s; 
            border: 3px solid #5D4037; 
            box-shadow: 4px 4px 0px #5D4037; 
            border-radius: 16px; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            cursor: pointer; 
        }
        .btn-3d:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #5D4037; }
        .btn-3d:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: 4px 4px 0px #5D4037; }

        .nav-btn-settings { background-color: #FF5252; color: white; border: 3px solid #5D4037; box-shadow: 0px 4px 0px #3E2723; transform: translateY(-10px); z-index: 50; }
        .nav-btn-settings.active { background-color: #FF1744; transform: translateY(-16px) scale(1.1); box-shadow: 0px 6px 0px #3E2723; border: 3px solid #FFF; outline: 3px solid #5D4037; }

        /* Color Palettes */
        .bg-mint { background-color: #CDF0EA; } 
        .bg-yellow { background-color: #FDFD96; } 
        .bg-pink { background-color: #FFC4C4; } 
        .bg-blue-soft { background-color: #C4E4FF; } 
        .bg-purple-soft { background-color: #E2C4FF; } 
        .bg-orange-soft { background-color: #FFD8B1; } 
        .bg-red-alert { background-color: #FF8A80; color: white; } 
        .bg-line { background-color: #06C755; color: white; }
        .bg-coffee { background-color: #5D4037; color: white; }
        .text-coffee { color: #5D4037; } 
        .border-coffee { border-color: #5D4037; }

        .doodle-card { 
            background: white; 
            border: 3px solid #5D4037; 
            border-radius: 24px; 
            box-shadow: 6px 6px 0px rgba(93, 64, 55, 0.2); 
            position: relative;
        }

        .input-hand { 
            border: 3px solid #5D4037; 
            border-radius: 12px; 
            padding: 12px 16px; 
            background: #FFF; 
            font-family: 'ZCOOL KuaiLe', cursive; 
            outline: none; 
            width: 100%; 
            font-size: 1.1rem; 
        }
        .input-hand:focus { box-shadow: 3px 3px 0px #5D4037; }

        /* Loaders & Overlays */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #FEF9F2; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 5px solid #5D4037; border-top: 5px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Print Styles - Improved for Preview */
        #print-area { 
            display: none; 
        }
        #print-area.show {
            display: block;
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: white; 
            z-index: 99999; 
            overflow-y: auto; /* Allow scrolling in preview */
            padding-bottom: 50px;
        }

        @media print {
            body * { visibility: hidden; }
            #print-area.show { position: absolute; height: auto; overflow: visible; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 99999; }
            @page { margin: 5mm; size: A4; } /* Standard A4, small margin */
            .no-print { display: none !important; } /* Hide close button when printing */
        }

        /* Animations */
        @keyframes toast-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-toast { animation: toast-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes wiggle { 0%, 100% { transform: rotate(-3deg); } 50% { transform: rotate(3deg); } }
        .animate-wiggle { animation: wiggle 2s ease-in-out infinite; }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- File Processing Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
</head>
<body>
    <div id="print-area"></div>
    <div id="root">
        <div id="loading-screen">
            <div class="spinner"></div>
            <h2 style="color: #5D4037; font-weight: bold;">正在啟動班級小管家...</h2>
            <p id="loading-text" style="margin-top: 10px; color: #8D6E63; font-size: 14px;">初始化中...</p>
        </div>
    </div>

    <!-- Safety Fallback Script -->
    <script>
        setTimeout(function() {
            var loader = document.getElementById('loading-screen');
            if (loader && loader.style.display !== 'none') {
                console.warn("Force removing loader due to timeout");
                // Check if React rendered anything
                if (document.getElementById('root').childElementCount > 1) {
                    loader.style.opacity = '0';
                    setTimeout(function(){ loader.style.display = 'none'; }, 500);
                } else {
                    document.getElementById('loading-text').innerText = "載入過久，請嘗試重新整理頁面。";
                    document.getElementById('loading-text').style.color = "red";
                }
            }
        }, 5000); // 5 seconds timeout
    </script>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icons = {
            CuteBear: () => (
                <svg viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg" style={{width: '100%', height: '100%'}}>
                    <circle cx="40" cy="50" r="30" fill="#8D6E63" stroke="#5D4037" strokeWidth="8"/>
                    <circle cx="160" cy="50" r="30" fill="#8D6E63" stroke="#5D4037" strokeWidth="8"/>
                    <circle cx="100" cy="100" r="80" fill="#D7CCC8" stroke="#5D4037" strokeWidth="8"/>
                    <circle cx="70" cy="90" r="10" fill="#3E2723"/>
                    <circle cx="130" cy="90" r="10" fill="#3E2723"/>
                    <ellipse cx="100" cy="110" rx="25" ry="20" fill="#EFEBE9"/>
                    <circle cx="100" cy="105" r="8" fill="#3E2723"/>
                    <path d="M100 113 L100 125 M90 125 Q100 135 110 125" stroke="#3E2723" strokeWidth="6" strokeLinecap="round"/>
                    <circle cx="50" cy="110" r="12" fill="#FFAB91" opacity="0.6"/>
                    <circle cx="150" cy="110" r="12" fill="#FFAB91" opacity="0.6"/>
                </svg>
            ),
            Clock: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            PackageX: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" y1="22" x2="12" y2="12"/><path d="m17 13 5 5m-5 0 5-5"/></svg>,
            MicOff: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            AlertCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            MessageCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            FileWarning: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            BookOpen: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Coffee: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            PenTool: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>,
            Stethoscope: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3"/><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4"/><circle cx="20" cy="10" r="2"/></svg>,
            Briefcase: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Palmtree: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 8c0-2.76-2.46-5-5.5-5S2 5.24 2 8h2l1-1 1 1h4"/><path d="M13 7.14A5.82 5.82 0 0 1 16.5 6c3.04 0 5.5 2.24 5.5 5h-3l-1-1-1 1h-3"/><path d="M5.89 9.71c-2.15 2.15-2.3 5.47-.35 7.43l4.24-4.25.7-.7.71-.71 2.12-2.12c-1.95-1.96-5.27-1.8-7.42.35z"/><path d="M11 15.5c.5 2.5-.17 4.5-1 6.5h4c2-5.5-.5-12-1-14"/></svg>,
            HelpCircle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Star: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            User: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            CheckCircle2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Edit3: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>,
            Trash2: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            ClipboardCopy: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Download: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-.69 2.82l.14.23a2 2 0 0 1 0 2l-.14.23a2 2 0 0 0 .69 2.82l.45.26a2 2 0 0 0 2 0l.18-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.18.08a2 2 0 0 0 2 0l.45-.26a2 2 0 0 0 .69-2.82l-.14-.23a2 2 0 0 1 0-2l.14-.23a2 2 0 0 0-.69-2.82l-.45-.26a2 2 0 0 0-2 0l-.18.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            FileSpreadsheet: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            List: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            UserCog: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><circle cx="19" cy="11" r="2"/><path d="M19 8v1"/><path d="M19 13v1"/></svg>,
            Share: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>,
            MoreVertical: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            LayoutGrid: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Info: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            AlertTriangle: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Megaphone: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 11 18-5v12L3 14v-3z"/><path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"/></svg>,
            Send: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Printer: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Upload: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Camera: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            Sparkles: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 7h4"/><path d="M3 5h4"/></svg>,
            Key: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>,
            Trash: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            RefreshCw: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Save: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        };

        const Icon = ({ name, className = "" }) => {
            const IconComponent = Icons[name] || Icons['AlertCircle'];
            return <span className={`inline-flex items-center justify-center ${className}`}><IconComponent /></span>;
        };

        // --- Constants ---
        const PERIODS = [
            { id: 'early', label: '早修' }, { id: 'p1', label: '第一節' }, { id: 'p2', label: '第二節' }, { id: 'p3', label: '第三節' }, { id: 'p4', label: '第四節' },
            { id: 'lunch', label: '午餐' }, { id: 'nap', label: '午休' }, { id: 'p5', label: '第五節' }, { id: 'p6', label: '第六節' }, { id: 'p7', label: '第七節' }, { id: 'p8', label: '第八節' },
        ];

        const DEFAULT_BEHAVIORS = [
            { id: 'item_missing', label: '物品未帶', icon: 'PackageX', color: 'bg-pink' },
            { id: 'late_class', label: '晚進教室', icon: 'Clock', color: 'bg-yellow' },
            { id: 'rude', label: '對師不禮貌', icon: 'MicOff', color: 'bg-pink' },
            { id: 'noise', label: '吵鬧干擾', icon: 'AlertCircle', color: 'bg-pink' },
            { id: 'chat', label: '聊天', icon: 'MessageCircle', color: 'bg-yellow' },
            { id: 'note', label: '傳紙條', icon: 'FileWarning', color: 'bg-yellow' },
            { id: 'other_book', label: '看課外書', icon: 'BookOpen', color: 'bg-yellow' },
            { id: 'sleep', label: '打瞌睡', icon: 'Coffee', color: 'bg-pink' },
            { id: 'no_hw_cls', label: '作業未交', icon: 'FileWarning', color: 'bg-pink' },
            { id: 'other', label: '其他', icon: 'PenTool', color: 'bg-blue-soft' },
        ];

        const ATTENDANCE_TYPES = [
            { id: 'late', label: '遲到', icon: 'Clock', color: 'bg-yellow' },
            { id: 'sick', label: '病假', icon: 'Stethoscope', color: 'bg-mint' },
            { id: 'official', label: '公假', icon: 'Briefcase', color: 'bg-blue-soft' },
            { id: 'personal', label: '事假', icon: 'Palmtree', color: 'bg-purple-soft' },
            { id: 'other_leave', label: '其他', icon: 'HelpCircle', color: 'bg-gray-200' },
            { id: 'absent', label: '缺席', icon: 'AlertCircle', color: 'bg-pink' },
        ];

        const CONTACT_BOOK_TYPES = [
            { id: 'cb_missing', label: '聯絡簿家長未簽名', icon: 'X', color: 'bg-pink' },
            { id: 'cb_late', label: '聯絡簿缺交', icon: 'Clock', color: 'bg-yellow' },
            { id: 'cb_good', label: '聯絡簿優良', icon: 'Star', color: 'bg-mint' },
        ];

        const DEFAULT_SUBJECTS = [
            { id: 'chinese', label: '國文' }, { id: 'english', label: '英語' }, { id: 'math', label: '數學' },
            { id: 'science', label: '理化' }, { id: 'civics', label: '公民' }, { id: 'history', label: '歷史' }, { id: 'geo', label: '地理' },
        ];

        // --- Shared Components (Toast & Modal) ---

        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-gray-800');

            return (
                <div className={`fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl text-white font-bold flex items-center gap-3 z-[99999] animate-toast ${bgClass}`}>
                    <Icon name={type === 'error' ? 'AlertTriangle' : 'CheckCircle2'} className="w-5 h-5"/>
                    <span>{message}</span>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl border-4 border-coffee p-6 max-w-sm w-full shadow-2xl animate-[bounce_0.3s_ease-out]">
                        <h3 className="text-xl font-bold text-coffee mb-4 whitespace-pre-line text-center">{message}</h3>
                        <div className="flex gap-4 justify-center">
                            <button onClick={onCancel} className="btn-3d bg-gray-200 px-6 py-2 text-coffee text-lg">取消</button>
                            <button onClick={onConfirm} className="btn-3d bg-yellow px-6 py-2 text-coffee text-lg">確定</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CustomPrompt = ({ isOpen, title, defaultValue, onConfirm, onCancel }) => {
            const [val, setVal] = useState(defaultValue);
            useEffect(() => { if(isOpen) setVal(defaultValue); }, [isOpen, defaultValue]);
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-[10000] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl border-4 border-coffee p-6 max-w-sm w-full shadow-2xl">
                        <h3 className="text-xl font-bold text-coffee mb-4">{title}</h3>
                        <input autoFocus type="text" value={val} onChange={e=>setVal(e.target.value)} className="input-hand mb-4" />
                        <div className="flex gap-4 justify-end">
                            <button onClick={onCancel} className="btn-3d bg-gray-200 px-4 py-2 text-coffee">取消</button>
                            <button onClick={() => onConfirm(val)} className="btn-3d bg-mint px-4 py-2 text-coffee">確定</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        function ClassManagerLine() {
            const [activeTab, setActiveTab] = useState('basic'); 
            const [notification, setNotification] = useState(null);
            const [modalConfig, setModalConfig] = useState({ isOpen: false, message: '', onConfirm: null });
            const [promptConfig, setPromptConfig] = useState({ isOpen: false, title: '', defaultValue: '', onConfirm: null });

            const [currentDate, setCurrentDate] = useState(() => {
                try {
                    const now = new Date();
                    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                    const gmt8Time = new Date(utc + (3600000 * 8));
                    return gmt8Time.toISOString().split('T')[0];
                } catch(e) { return new Date().toISOString().split('T')[0]; }
            });
          
            const [allData, setAllData] = useState(() => {
                try { 
                    const saved = localStorage.getItem('classLogDB_Line'); 
                    return saved ? JSON.parse(saved) : {}; 
                } catch { return {}; }
            });

            const [week, setWeek] = useState('1'); 
            const [dutyStudent, setDutyStudent] = useState('1');
            const [attendanceData, setAttendanceData] = useState({});
            const [missingData, setMissingData] = useState({});
            const [classLogData, setClassLogData] = useState({});
            const [periodNotes, setPeriodNotes] = useState({}); 
            const [incidentLog, setIncidentLog] = useState('');
            const [attendanceNotes, setAttendanceNotes] = useState({}); 
          
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('geminiApiKey') || "");
            const [isAiProcessing, setIsAiProcessing] = useState(false);

            const [subjects, setSubjects] = useState(() => { try { const s = localStorage.getItem('classLogSubjects'); return s ? JSON.parse(s) : DEFAULT_SUBJECTS; } catch { return DEFAULT_SUBJECTS; } });
            const [behaviors, setBehaviors] = useState(() => { try { const b = localStorage.getItem('classLogBehaviors'); return b ? JSON.parse(b) : DEFAULT_BEHAVIORS; } catch { return DEFAULT_BEHAVIORS; } });
            const [students, setStudents] = useState(() => { try { const s = localStorage.getItem('classLogStudents'); return s ? JSON.parse(s) : Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}號` })); } catch { return Array.from({ length: 30 }, (_, i) => ({ id: i + 1, name: `${i + 1}號` })); } });
          
            const [newSubjectName, setNewSubjectName] = useState('');
            const [isAddingSubject, setIsAddingSubject] = useState(false);
            const [newBehaviorName, setNewBehaviorName] = useState('');
            const [isEditingBehaviors, setIsEditingBehaviors] = useState(false);
            const [isSelectorOpen, setIsSelectorOpen] = useState(false);
            const [selectorConfig, setSelectorConfig] = useState({ type: '', category: '', period: '' });
          
            const [selectedStudentReport, setSelectedStudentReport] = useState(1);
            const [finalReportText, setFinalReportText] = useState(""); 

            const [bulkNamesInput, setBulkNamesInput] = useState(''); 
            const [currentSubjectId, setCurrentSubjectId] = useState('');
            const [currentLogPeriod, setCurrentLogPeriod] = useState('p1');
            const [teacherNote, setTeacherNote] = useState(() => localStorage.getItem('classLogTeacherNote') || '');
            const [isProcessing, setIsProcessing] = useState(false);
            const fileInputRef = useRef(null);
            const backupInputRef = useRef(null);

            const [rangeStartDate, setRangeStartDate] = useState(() => {
                const d = new Date();
                d.setMonth(d.getMonth() - 1); 
                return d.toISOString().split('T')[0];
            });
            const [rangeEndDate, setRangeEndDate] = useState(() => new Date().toISOString().split('T')[0]);

            const showToast = (msg, type = 'success') => setNotification({ message: msg, type });
            const showConfirm = (msg, onConfirm) => setModalConfig({ isOpen: true, message: msg, onConfirm: () => { onConfirm(); setModalConfig({ isOpen: false, message: '', onConfirm: null }); } });
            const showPrompt = (title, defaultValue, onConfirm) => setPromptConfig({ isOpen: true, title, defaultValue, onConfirm: (val) => { onConfirm(val); setPromptConfig(prev => ({ ...prev, isOpen: false })); } });

            useEffect(() => {
                const dayData = allData[currentDate] || {};
                setWeek(dayData.week || '1');
                setDutyStudent(dayData.dutyStudent || '1');
                setAttendanceData(dayData.attendanceData || {});
                setMissingData(dayData.missingData || {});
                setClassLogData(dayData.classLogData || {});
                setPeriodNotes(dayData.periodNotes || {});
                setIncidentLog(dayData.incidentLog || '');
                setAttendanceNotes(dayData.attendanceNotes || {}); 
            }, [currentDate, allData]); 

            useEffect(() => {
                const timer = setTimeout(() => {
                    setAllData(prev => ({ ...prev, [currentDate]: { week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes } }));
                    localStorage.setItem('classLogDB_Line', JSON.stringify({ ...allData, [currentDate]: { week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes } }));
                }, 500);
                return () => clearTimeout(timer);
            }, [week, dutyStudent, attendanceData, missingData, classLogData, periodNotes, incidentLog, attendanceNotes, currentDate]);

            useEffect(() => {
                localStorage.setItem('classLogSubjects', JSON.stringify(subjects));
                localStorage.setItem('classLogBehaviors', JSON.stringify(behaviors));
                localStorage.setItem('classLogStudents', JSON.stringify(students));
            }, [subjects, behaviors, students]);

            useEffect(() => { localStorage.setItem('classLogTeacherNote', teacherNote); }, [teacherNote]);
            useEffect(() => { if (subjects.length > 0 && !currentSubjectId) setCurrentSubjectId(subjects[0].id); }, [subjects, currentSubjectId]);
            useEffect(() => { localStorage.setItem('geminiApiKey', userApiKey); }, [userApiKey]);

            useEffect(() => {
                const data = generateParentMessage(selectedStudentReport, true);
                setFinalReportText(data.text);
            }, [selectedStudentReport, teacherNote, allData]); 

            const handleUpdateStudentName = (id, newName) => {
                setStudents(prev => prev.map(s => s.id === id ? { ...s, name: newName } : s));
            };

            const callGemini = async (prompt) => {
                if (!userApiKey) { showToast("請先在【設定】頁面輸入 Gemini API Key 喔！", "error"); return null; }
                setIsAiProcessing(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${userApiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    setIsAiProcessing(false);
                    if (data.error) { showToast("API 錯誤: " + data.error.message, "error"); return null; }
                    return data.candidates[0].content.parts[0].text;
                } catch (error) { setIsAiProcessing(false); showToast("連線失敗: " + error.message, "error"); return null; }
            };

            const handleAiGenerateReport = async () => {
                const student = students.find(s => s.id === selectedStudentReport);
                if (!student) return;
                const { stats, detailedBehaviors } = getWeeklyStats(selectedStudentReport);
                const prompt = `你是一位充滿愛心與智慧的國中班導師，請根據以下數據，為學生「${student.name}」寫一段給家長的週報評語 (約 100-150字)。\n數據：缺勤 ${Object.values(stats.attendance).reduce((a,b)=>a+b,0)} 次, 缺交 ${Object.values(stats.missing).reduce((a,b)=>a+b,0)} 次, 違規 ${Object.values(stats.behavior).reduce((a,b)=>a+b,0)} 次。\n違規細節：${detailedBehaviors.join(', ')}。\n語氣：溫暖、鼓勵但明確指出需要改進的地方，結尾請家長簽名。`;
                const result = await callGemini(prompt);
                if (result) setFinalReportText(result);
            };

            const handleAiPolishLog = async () => {
                if (!incidentLog.trim()) { showToast("請先輸入一些紀錄內容喔！", "error"); return; }
                const prompt = `請扮演一位資深教育行政人員，將以下班級偶發事件紀錄改寫得更正式、客觀、精簡，適合呈報給學校行政單位：\n${incidentLog}`;
                const result = await callGemini(prompt);
                if (result) {
                    showConfirm("AI 改寫完成！是否要替換目前的內容？\n\n" + result.substring(0, 100) + "...", () => setIncidentLog(result));
                }
            };

            const processFile = (file) => {
                setIsProcessing(true);
                const reader = new FileReader();
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                            let names = [];
                            jsonData.forEach(row => { if(row[0] && typeof row[0] === 'string') names.push(row[0]); });
                            if(names.length > 0) { setBulkNamesInput(names.join('\n')); showToast(`已讀取 ${names.length} 筆資料。`); }
                        } catch(err) { showToast('Excel 解析失敗', 'error'); }
                        setIsProcessing(false);
                    };
                    reader.readAsArrayBuffer(file);
                } 
                else if (fileName.endsWith('.docx')) {
                    reader.onload = (e) => {
                        mammoth.extractRawText({arrayBuffer: e.target.result}).then(result => {
                            setBulkNamesInput(result.value.split('\n').map(l=>l.trim()).filter(l=>l).join('\n'));
                            showToast('已讀取 Word 文字。');
                            setIsProcessing(false);
                        });
                    };
                    reader.readAsArrayBuffer(file);
                }
                else if (file.type.startsWith('image/')) {
                    Tesseract.recognize(file, 'chi_tra').then(({ data: { text } }) => {
                        setBulkNamesInput(text.split(/\s+/).filter(s => s.length >= 2).join('\n'));
                        showToast('圖片辨識完成！');
                        setIsProcessing(false);
                    });
                } else { showToast('不支援的格式。', 'error'); setIsProcessing(false); }
            };

            const handleBulkImportNames = () => {
              if (!bulkNamesInput.trim()) return;
              const names = bulkNamesInput.split(/\n/).map(n => n.trim()).filter(n => n);
              showConfirm(`即將匯入 ${names.length} 位學生，這將會覆蓋現有名單，確定嗎？`, () => {
                  setStudents(names.map((name, index) => ({ id: index + 1, name: name })));
                  setBulkNamesInput('');
                  showToast('匯入成功！');
              });
            };
          
            const handleAddSubject = () => { 
                if (newSubjectName.trim()) { 
                    const newId = `sub_${Date.now()}`; 
                    setSubjects([...subjects, { id: newId, label: newSubjectName.trim() }]); 
                    setNewSubjectName(''); 
                    setIsAddingSubject(false); 
                    setCurrentSubjectId(newId); 
                } else { showToast("請輸入科目名稱", 'error'); }
            };
            const handleDeleteSubject = (id, e) => { e.stopPropagation(); showConfirm('確定刪除此科目？', () => setSubjects(subjects.filter(s => s.id !== id))); };
          
            const handleAddBehavior = () => { 
                if (newBehaviorName.trim()) { 
                    setBehaviors([...behaviors, { id: `beh_${Date.now()}`, label: newBehaviorName.trim(), icon: 'AlertCircle', color: 'bg-yellow' }]); 
                    setNewBehaviorName(''); 
                } else { showToast("請輸入名稱", 'error'); }
            };
            const handleDeleteBehavior = (id, e) => { e.stopPropagation(); showConfirm('確定刪除此項目？', () => setBehaviors(behaviors.filter(b => b.id !== id))); };
          
            const handleAttendanceClick = (typeId) => {
                if (typeId === 'other_leave') {
                    const currentNote = attendanceNotes['other_leave'] || "";
                    showPrompt("請輸入「其他」缺席的原因 (例如：事假、喪假)：", currentNote, (note) => {
                        if (note) setAttendanceNotes(prev => ({ ...prev, 'other_leave': note }));
                        openSelector('attendance', typeId);
                    });
                } else {
                    openSelector('attendance', typeId);
                }
            };
          
            const handleBehaviorClick = (behaviorId) => {
              if (isEditingBehaviors) return;
              if (behaviorId === 'other') {
                const currentNote = periodNotes[currentLogPeriod] || '';
                showPrompt(`請輸入 ${PERIODS.find(p=>p.id===currentLogPeriod)?.label} 的其他說明：`, currentNote, (note) => {
                    if (note) updatePeriodNote(note);
                    openSelector('log', behaviorId, currentLogPeriod);
                });
              } else {
                openSelector('log', behaviorId, currentLogPeriod);
              }
            };

            const openSelector = (type, category, period = null) => { setSelectorConfig({ type, category, period }); setIsSelectorOpen(true); };
          
            const toggleStudent = (studentId) => {
              const { type, category, period } = selectorConfig;
              if (type === 'attendance') setAttendanceData(prev => { const list = prev[category] || []; return { ...prev, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] }; });
              else if (type === 'missing') setMissingData(prev => { const list = prev[category] || []; return { ...prev, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] }; });
              else if (type === 'log') setClassLogData(prev => { const out = prev[period] || {}; const list = out[category] || []; return { ...prev, [period]: { ...out, [category]: list.includes(studentId) ? list.filter(id => id !== studentId) : [...list, studentId] } }; });
            };

            const getSelectedStudents = () => {
              const { type, category, period } = selectorConfig;
              if (type === 'attendance') return attendanceData[category] || [];
              if (type === 'missing') return missingData[category] || [];
              if (type === 'log') return classLogData[period]?.[category] || [];
              return [];
            };

            const updatePeriodNote = (val) => setPeriodNotes(prev => ({ ...prev, [currentLogPeriod]: val }));
            const downloadCSV = (content, filename) => {
              const link = document.createElement('a');
              link.href = URL.createObjectURL(new Blob(['\uFEFF' + content], { type: 'text/csv;charset=utf-8;' }));
              link.download = filename;
              link.click();
            };

            const getWeeklyStats = (studentId) => {
              const dates = []; const today = new Date(currentDate); 
              for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); }
              let stats = { attendance: {}, missing: {}, behavior: {} }; 
              let detailedBehaviors = [], detailedAttendance = [], detailedMissing = [];     
              dates.forEach(date => {
                const data = allData[date]; if (!data) return;
                const dateStr = date.slice(5).replace('-','/');
                if (data.attendanceData) Object.keys(data.attendanceData).forEach(k => { 
                    if (data.attendanceData[k]?.includes(studentId)) { 
                        stats.attendance[k] = (stats.attendance[k] || 0) + 1; 
                        const typeName = ATTENDANCE_TYPES.find(t=>t.id===k)?.label || k;
                        detailedAttendance.push(`${dateStr} ${typeName}`);
                    } 
                });
                if (data.missingData) Object.keys(data.missingData).forEach(k => { 
                    if (data.missingData[k]?.includes(studentId)) { 
                        let label = k; const sub = subjects.find(s => s.id === k); const cb = CONTACT_BOOK_TYPES.find(c => c.id === k); 
                        if (sub) label = sub.label + '作業缺交'; if (cb) label = cb.label; 
                        stats.missing[label] = (stats.missing[label] || 0) + 1; detailedMissing.push(`${dateStr} ${label}`);
                    } 
                });
                if (data.classLogData) Object.keys(data.classLogData).forEach(periodId => { 
                    const pLog = data.classLogData[periodId]; 
                    if (pLog) Object.keys(pLog).forEach(bId => { 
                        if (pLog[bId]?.includes(studentId)) { 
                            const b = behaviors.find(be => be.id === bId); const label = b ? b.label : '其他'; 
                            const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; 
                            stats.behavior[label] = (stats.behavior[label] || 0) + 1; 
                            detailedBehaviors.push(`${dateStr} ${periodLabel}：${label}`); 
                        } 
                    }); 
                });
              });
              return { dates, stats, detailedBehaviors: detailedBehaviors.reverse(), detailedAttendance: detailedAttendance.reverse(), detailedMissing: detailedMissing.reverse() };
            };

            const getRangeStats = (start, end) => {
                const sDate = new Date(start); const eDate = new Date(end); const statsMap = {};
                students.forEach(s => { statsMap[s.id] = { id: s.id, name: s.name, attendance: {}, missing: {}, behavior: {} }; });
                for (let d = new Date(sDate); d <= eDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0]; const dayData = allData[dateStr]; if (!dayData) continue;
                    if (dayData.attendanceData) Object.keys(dayData.attendanceData).forEach(typeId => { dayData.attendanceData[typeId]?.forEach(studId => { if (statsMap[studId]) statsMap[studId].attendance[typeId] = (statsMap[studId].attendance[typeId] || 0) + 1; }); });
                    if (dayData.missingData) Object.keys(dayData.missingData).forEach(itemId => { dayData.missingData[itemId]?.forEach(studId => { if (statsMap[studId]) statsMap[studId].missing[itemId] = (statsMap[studId].missing[itemId] || 0) + 1; }); });
                    if (dayData.classLogData) Object.values(dayData.classLogData).forEach(periodLog => { Object.keys(periodLog).forEach(behId => { periodLog[behId]?.forEach(studId => { if (statsMap[studId]) statsMap[studId].behavior[behId] = (statsMap[studId].behavior[behId] || 0) + 1; }); }); });
                }
                return statsMap;
            };

            const exportRangeCSV = () => {
                const stats = getRangeStats(rangeStartDate, rangeEndDate); let csv = "座號,姓名";
                const attHeaders = ATTENDANCE_TYPES.map(t => t.label);
                const missingKeys = [...CONTACT_BOOK_TYPES.map(t=>t.id), ...subjects.map(s=>s.id)];
                const missingLabels = [...CONTACT_BOOK_TYPES.map(t=>t.label), ...subjects.map(s=>s.label + '缺交')];
                const behHeaders = behaviors.map(b => b.label);
                csv += "," + attHeaders.join(",") + ",總缺勤" + "," + missingLabels.join(",") + ",總缺交" + "," + behHeaders.join(",") + ",總違規\n";
                students.forEach(s => {
                    const data = stats[s.id]; let row = `${s.id},${s.name}`;
                    let totalAtt = 0; ATTENDANCE_TYPES.forEach(t => { const count = data.attendance[t.id] || 0; row += `,${count}`; totalAtt += count; }); row += `,${totalAtt}`;
                    let totalMiss = 0; missingKeys.forEach(k => { const count = data.missing[k] || 0; row += `,${count}`; totalMiss += count; }); row += `,${totalMiss}`;
                    let totalBeh = 0; behaviors.forEach(b => { const count = data.behavior[b.id] || 0; row += `,${count}`; totalBeh += count; }); row += `,${totalBeh}`;
                    csv += row + "\n";
                });
                downloadCSV(csv, `班級統計_${rangeStartDate}_to_${rangeEndDate}.csv`);
            };

            const getDailyStudentViolations = () => {
              const studentViolations = {};
              PERIODS.forEach(p => {
                const logs = classLogData[p.id]; if (!logs) return;
                behaviors.forEach(b => { const list = logs[b.id]; if (list && list.length > 0) list.forEach(studentId => { if (!studentViolations[studentId]) studentViolations[studentId] = []; studentViolations[studentId].push(`${p.label}: ${b.label}`); }); });
              });
              return studentViolations;
            };

            const exportDailyLog = () => {
              let csv = `班級日誌,日期：${currentDate},週次：${week},值日生：${dutyStudent}\n\n【到校】\n類別,學生\n`;
              ATTENDANCE_TYPES.forEach(t => { const list = attendanceData[t.id]?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('、') || ''; if(list) csv += `${t.label},"${list}"\n`; });
              csv += `\n【作業】\n項目,缺交\n`;
              const getMissingNames = (list) => list?.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('、') || '';
              CONTACT_BOOK_TYPES.forEach(t => { const str = getMissingNames(missingData[t.id]); if(str) csv += `${t.label},"${str}"\n`; });
              subjects.forEach(s => { const str = getMissingNames(missingData[s.id]); if(str) csv += `${s.label}缺交,"${str}"\n`; });
              csv += `\n【課堂】\n時段,行為,學生,備註\n`;
              PERIODS.forEach(p => {
                const logs = classLogData[p.id]; const note = periodNotes[p.id] || '';
                if (logs) behaviors.forEach(b => { const rawList = logs[b.id]; if (rawList && rawList.length > 0) { const names = rawList.map(id => { const s = students.find(stud => stud.id === id); return s ? `${id}(${s.name})` : id; }).join('、'); csv += `${p.label},${b.label},"${names}","${note}"\n`; } });
                if ((!logs || Object.keys(logs).every(k => logs[k].length === 0)) && note) csv += `${p.label},備註,,"${note}"\n`;
              });
              csv += `\n【偶發】\n"${incidentLog.replace(/"/g, '""')}"\n`;
              downloadCSV(csv, `班級日誌_${currentDate}.csv`);
            };

            const exportWholeClassWeekly = () => { 
                 const dates = []; const today = new Date(currentDate); for (let i = 0; i < 5; i++) { const d = new Date(today); d.setDate(today.getDate() - i); dates.push(d.toISOString().split('T')[0]); } 
                 let csv = `全班週報表\n統計範圍,${dates[dates.length-1]} ~ ${dates[0]}\n\n座號,姓名,缺勤總數,缺交總數,違規總數,缺勤明細,缺交明細,違規明細\n`; 
                 students.forEach(student => { const { stats } = getWeeklyStats(student.id); const totalAtt = Object.values(stats.attendance).reduce((a,b) => a+b, 0); const totalMiss = Object.values(stats.missing).reduce((a,b) => a+b, 0); const totalBeh = Object.values(stats.behavior).reduce((a,b) => a+b, 0); const strAtt = Object.entries(stats.attendance).map(([k,v]) => { const t = ATTENDANCE_TYPES.find(x => x.id === k); return `${t?.label || k}(${v})`; }).join('、'); const strMiss = Object.entries(stats.missing).map(([k,v]) => `${k}(${v})`).join('、'); const strBeh = Object.entries(stats.behavior).map(([k,v]) => `${k}(${v})`).join('、'); csv += `${student.id},${student.name},${totalAtt},${totalMiss},${totalBeh},"${strAtt}","${strMiss}","${strBeh}"\n`; }); 
                 downloadCSV(csv, `全班週報表_${currentDate}.csv`); 
            };
          
            const handleResetData = () => { showConfirm("⚠️ 警告：這將會刪除所有歷史資料！\n此動作無法復原。\n\n確定要重置嗎？", () => { localStorage.removeItem('classLogDB_Line'); localStorage.removeItem('classLogTeacherNote'); showToast("資料已重置！"); setTimeout(() => window.location.reload(), 1000); }); };
            const handleBackupData = () => { const data = { version: "2.0", timestamp: new Date().toISOString(), classLogDB: JSON.parse(localStorage.getItem('classLogDB_Line') || '{}'), subjects: JSON.parse(localStorage.getItem('classLogSubjects') || '[]'), behaviors: JSON.parse(localStorage.getItem('classLogBehaviors') || '[]'), students: JSON.parse(localStorage.getItem('classLogStudents') || '[]'), teacherNote: localStorage.getItem('classLogTeacherNote') || '' }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `班級小管家備份_${new Date().toISOString().slice(0,10)}.json`; a.click(); };
            const handleRestoreData = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.classLogDB) localStorage.setItem('classLogDB_Line', JSON.stringify(data.classLogDB)); if (data.subjects) localStorage.setItem('classLogSubjects', JSON.stringify(data.subjects)); if (data.behaviors) localStorage.setItem('classLogBehaviors', JSON.stringify(data.behaviors)); if (data.students) localStorage.setItem('classLogStudents', JSON.stringify(data.students)); if (data.teacherNote) localStorage.setItem('classLogTeacherNote', data.teacherNote); showToast("資料還原成功！"); setTimeout(() => window.location.reload(), 1000); } catch (err) { showToast("還原失敗", 'error'); } }; reader.readAsText(file); };

            const generateParentMessage = (studentId, returnOnly = false) => { 
                const s = students.find(stud => stud.id === studentId); 
                if (!s) return { text: "請先選擇學生...", structured: null }; 
                
                const { dates } = getWeeklyStats(studentId); 
                const dateRange = `${dates[dates.length-1].slice(5).replace('-','/')} ~ ${dates[0].slice(5).replace('-','/')}`; 
                
                let report = { attendance: { count: 0, logs: [] }, contact: { count: 0, logs: [] }, homework: { count: 0, logs: [] }, discipline: { count: 0, logs: [] } };

                dates.forEach(date => {
                    const data = allData[date]; if (!data) return;
                    const dateStr = date.slice(5).replace('-','/');
                    if (data.attendanceData) Object.keys(data.attendanceData).forEach(k => { if (data.attendanceData[k]?.includes(studentId)) { report.attendance.count++; const typeName = ATTENDANCE_TYPES.find(t=>t.id===k)?.label || k; let note = ''; if(k === 'other_leave' && data.attendanceNotes?.['other_leave']) { note = ` (${data.attendanceNotes['other_leave']})`; } report.attendance.logs.push(`${dateStr} ${typeName}${note}`); } });
                    if (data.missingData) Object.keys(data.missingData).forEach(k => { if (data.missingData[k]?.includes(studentId)) { const isContact = CONTACT_BOOK_TYPES.find(c => c.id === k); if (isContact) { report.contact.count++; report.contact.logs.push(`${dateStr} ${isContact.label}`); } else { const sub = subjects.find(s => s.id === k); const label = sub ? `${sub.label}作業` : k; report.homework.count++; report.homework.logs.push(`${dateStr} ${label}`); } } });
                    if (data.classLogData) Object.keys(data.classLogData).forEach(periodId => { const pLog = data.classLogData[periodId]; if (pLog) Object.keys(pLog).forEach(bId => { if (pLog[bId]?.includes(studentId)) { const b = behaviors.find(be => be.id === bId); const label = b ? b.label : '其他'; const periodLabel = PERIODS.find(p => p.id === periodId)?.label || periodId; let note = ''; if(bId === 'other' && data.periodNotes?.[periodId]) { note = ` (${data.periodNotes[periodId]})`; } report.discipline.count++; report.discipline.logs.push(`${dateStr} ${periodLabel}：${label}${note}`); } }); });
                });

                let msg = ""; 
                if (teacherNote.trim()) msg += `📢 重要事項!!\n${teacherNote}\n\n`; 
                msg += `【班級週報】${s.name} (${dateRange})\n`;
                msg += `\n1️⃣ 缺勤紀錄 (共${report.attendance.count}次)：\n${report.attendance.logs.length ? report.attendance.logs.map(l=>`   • ${l}`).join('\n') : "   (全勤)"}`;
                msg += `\n\n2️⃣ 聯絡簿狀況 (共${report.contact.count}次)：\n${report.contact.logs.length ? report.contact.logs.map(l=>`   • ${l}`).join('\n') : "   (良好)"}`;
                msg += `\n\n3️⃣ 作業缺交 (共${report.homework.count}次)：\n${report.homework.logs.length ? report.homework.logs.map(l=>`   • ${l}`).join('\n') : "   (按時繳交)"}`;
                msg += `\n\n4️⃣ 常規表現 (共${report.discipline.count}次)：\n${report.discipline.logs.length ? report.discipline.logs.map(l=>`   • ${l}`).join('\n') : "   (表現穩定)"}`;
                // msg += `\n\n------------------------------\n家長簽名：`; 
                
                return { text: msg, structured: report, dateRange, studentName: s.name };
            };

            const handlePrintAllStudents = () => {
                const printArea = document.getElementById('print-area');
                if (!printArea) return showToast('列印區塊初始化失敗', 'error');

                let html = '<style>';
                html += '@media print { @page { size: A4; margin: 10mm; } .no-print { display: none !important; } }';
                html += 'body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }';
                
                // --- 修正後的 6人/頁 (2x3 Grid) ---
                html += '.page { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(3, 1fr); gap: 10px; height: 277mm; page-break-after: always; box-sizing: border-box; }'; // A4 Height ~297mm - 20mm margin = 277mm
                
                html += '.card { border: 2px solid #5D4037; padding: 8px; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; height: 100%; box-sizing: border-box; background: white; }';
                html += '.header { border-bottom: 1px solid #5D4037; padding-bottom: 4px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: baseline; }';
                html += '.title { font-size: 16px; font-weight: bold; }'; 
                html += '.info { font-size: 12px; }';
                html += '.note-box { background: #eee; padding: 4px; border-radius: 4px; margin-bottom: 4px; font-size: 10px; flex-shrink: 0; max-height: 40px; overflow: hidden; }';
                html += '.note-title { font-weight: bold; text-align: center; color: red; margin-bottom: 2px; }';
                
                // Content Grid (4 quadrants) - Compact
                html += '.section-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; flex-grow: 1; overflow: hidden; }'; 
                html += '.section { font-size: 9px; border: 1px dashed #aaa; padding: 3px; border-radius: 4px; overflow-y: hidden; }'; 
                html += '.sec-title { font-weight: bold; background: #5D4037; color: white; padding: 1px 4px; border-radius: 3px; display: inline-block; margin-bottom: 2px; font-size: 10px;}';
                html += '.log-item { margin-left: 4px; line-height: 1.1; border-bottom: 1px dotted #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }'; 
                
                html += '.signature-box { margin-top: 4px; text-align: right; font-weight: bold; font-size: 12px; padding-top: 5px; border-top: 1px dashed #ccc; flex-shrink: 0; }';
                html += '</style>';

                // Close Button UI
                html += '<div class="no-print" style="position: fixed; top: 20px; right: 20px; z-index: 2147483647;">';
                html += '<button onclick="document.getElementById(\'print-area\').classList.remove(\'show\'); document.getElementById(\'print-area\').innerHTML=\'\';" style="padding: 12px 24px; background-color: #FF5252; color: white; border: 3px solid #5D4037; border-radius: 12px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 3px 3px 0 #3E2723; display: flex; align-items: center; gap: 5px;">❌ 關閉預覽 / 返回</button>';
                html += '</div>';

                let chunks = []; for (let i = 0; i < students.length; i += 6) { chunks.push(students.slice(i, i + 6)); }

                chunks.forEach(chunk => {
                    html += '<div class="page">';
                    chunk.forEach(student => {
                        const data = generateParentMessage(student.id, true);
                        const r = data.structured;
                        html += `<div class="card">
                            <div class="header"><div class="title">班級週報</div><div class="info">${data.studentName} | ${data.dateRange}</div></div>
                            ${teacherNote ? `<div class="note-box"><div class="note-title"><u>重要事項!!</u></div><div>${teacherNote}</div></div>` : ''}
                            <div class="section-grid">
                                <div class="section"><div class="sec-title">缺勤 (${r.attendance.count})</div>${r.attendance.logs.map(l=>`<div class="log-item">• ${l}</div>`).join('') || '<div class="log-item">全勤</div>'}</div>
                                <div class="section"><div class="sec-title">聯絡簿 (${r.contact.count})</div>${r.contact.logs.map(l=>`<div class="log-item">• ${l}</div>`).join('') || '<div class="log-item">良好</div>'}</div>
                                <div class="section"><div class="sec-title">作業 (${r.homework.count})</div>${r.homework.logs.map(l=>`<div class="log-item">• ${l}</div>`).join('') || '<div class="log-item">按時繳交</div>'}</div>
                                <div class="section"><div class="sec-title">常規 (${r.discipline.count})</div>${r.discipline.logs.map(l=>`<div class="log-item">• ${l}</div>`).join('') || '<div class="log-item">表現穩定</div>'}</div>
                            </div>
                            <div class="signature-box">家長簽名：__________________</div>
                        </div>`;
                    });
                    html += '</div>';
                });
                
                printArea.innerHTML = html;
                printArea.classList.add('show');
                
                setTimeout(() => { 
                    window.print(); 
                }, 500);
            };

            const exportStudentWeekly = () => { const s = students.find(s => s.id === selectedStudentReport); if(!s) return showToast('請先選擇學生', 'error'); const { dates, stats } = getWeeklyStats(selectedStudentReport); let csv = `學生個別週報表\n座號,${s.id}\n姓名,${s.name}\n統計範圍,${dates[dates.length-1]} ~ ${dates[0]}\n\n類別,項目,次數\n`; Object.entries(stats.attendance).forEach(([k, v]) => csv += `缺勤,${ATTENDANCE_TYPES.find(t=>t.id===k)?.label||k},${v}\n`); Object.entries(stats.missing).forEach(([k, v]) => csv += `缺交,${k},${v}\n`); Object.entries(stats.behavior).forEach(([k, v]) => csv += `違規,${k},${v}\n`); downloadCSV(csv, `${s.name}_週報表.csv`); };
          
            const handleLineShare = (text) => window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
            const copyToClipboard = (text) => {
                 const textArea = document.createElement("textarea");
                 textArea.value = text;
                 document.body.appendChild(textArea);
                 textArea.select();
                 document.execCommand('copy');
                 document.body.removeChild(textArea);
                 showToast('已複製訊息！請直接貼上。');
            };

            // --- Views ---
            const renderStudentSelector = () => { 
                if (!isSelectorOpen) return null; 
                const selected = getSelectedStudents(); 
                const { type, category, period } = selectorConfig; 
                let title = ''; 
                if (type === 'attendance') title = ATTENDANCE_TYPES.find(t => t.id === category)?.label || '點名'; 
                if (type === 'missing') { const cbItem = CONTACT_BOOK_TYPES.find(t => t.id === category); const subjectItem = subjects.find(s => s.id === category); title = cbItem ? cbItem.label : (subjectItem ? `${subjectItem.label}缺交` : '項目'); } 
                if (type === 'log') { const pName = PERIODS.find(p => p.id === period)?.label || period; const bName = behaviors.find(b => b.id === category)?.label || '紀錄'; title = `${pName} - ${bName}`; } 
                return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"> <div className="bg-[#FEF9F2] w-full max-w-sm rounded-2xl border-4 border-coffee shadow-2xl overflow-hidden flex flex-col max-h-[85vh]"> <div className="bg-yellow p-4 border-b-4 border-coffee flex justify-between items-center"> <h3 className="text-2xl font-bold text-coffee">點選學生</h3> <button onClick={() => setIsSelectorOpen(false)} className="bg-white p-2 rounded-full border-2 border-coffee"><Icon name="CheckCircle2" className="w-8 h-8" /></button> </div> <div className="bg-yellow px-4 pb-2 text-coffee font-bold opacity-80 border-b-2 border-coffee mb-2">正在登記：{title}</div> <div className="p-4 overflow-y-auto grid grid-cols-4 gap-3"> {students.map(s => ( <button key={s.id} onClick={() => toggleStudent(s.id)} className={`p-2 rounded-xl border-2 border-coffee font-bold text-base flex flex-col items-center justify-center transition-all min-h-[70px] ${selected.includes(s.id) ? 'bg-coffee text-white transform scale-105 shadow-lg' : 'bg-white text-coffee hover:bg-gray-100'}`}> <span className="text-sm opacity-70 mb-1">#{s.id}</span> <span className="truncate w-full text-center text-lg">{s.name}</span> </button> ))} </div> <div className="p-4 bg-white border-t-4 border-coffee text-center"><button onClick={() => setIsSelectorOpen(false)} className="btn-3d w-full bg-mint py-4 text-2xl">完 成</button></div> </div> </div> ); 
            };

            const renderManual = () => ( 
              <div className="pb-24 space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300"> 
                  <div className="doodle-card p-5 bg-orange-soft"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2 border-b-2 border-coffee pb-2"><Icon name="Download" className="w-7 h-7"/> 如何安裝</h3><p className="mb-4 font-bold text-coffee opacity-80">請將此網頁【加入主畫面】，即可全螢幕使用！</p></div> 
                  <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-2"><Icon name="LayoutGrid" className="w-7 h-7"/> 功能導覽</h3><div className="space-y-4">{[{icon: 'UserCog', label: '設定', desc: '匯入名單、管理科目。', color: 'bg-red-alert'}, {icon: 'User', label: '點名', desc: '每日例行。紀錄遲到、請假。', color: 'bg-mint'}, {icon: 'Edit3', label: '紀錄', desc: '課堂違規追蹤。', color: 'bg-yellow'}, {icon: 'List', label: '日誌', desc: '自動彙整今日紀錄。', color: 'bg-pink'}, {icon: 'FileSpreadsheet', label: '報表', desc: '週報表與個別通知。', color: 'bg-blue-soft'}].map((item, idx) => (<div key={idx} className="flex items-start gap-3"><div className={`w-12 h-12 rounded-full ${item.color} flex items-center justify-center shrink-0 border-2 border-coffee`}><div className="text-white"><Icon name={item.icon} className="w-6 h-6"/></div></div><div><h4 className="font-bold text-xl">{item.label}</h4><p className="text-base opacity-70 leading-snug">{item.desc}</p></div></div>))}</div></div> 
              </div> 
            );
          
            const renderSettings = () => ( 
              <div className="pb-24 space-y-8"> 
                <button onClick={() => setActiveTab('manual')} className="w-full btn-3d bg-blue-soft py-4 text-coffee flex items-center justify-center gap-3 text-xl h-20 font-bold"><Icon name="BookOpen" className="w-7 h-7" /> 📖 查看使用說明書</button> 

                <div className="doodle-card p-5 bg-white border-4 border-yellow-200">
                    <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="Sparkles" className="w-8 h-8 text-yellow-500"/> AI 智慧助理設定</h3>
                    <div className="mb-4">
                        <label className="text-lg font-bold opacity-70 mb-2 block">Gemini API Key (選填)</label>
                        <div className="flex gap-2">
                          <div className="relative flex-grow">
                              <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"><Icon name="Key" className="w-5 h-5"/></span>
                              <input type="password" value={userApiKey} onChange={(e) => setUserApiKey(e.target.value)} className="input-hand pl-10 text-lg" placeholder="貼上您的 API Key..." />
                          </div>
                          {userApiKey && <span className="text-green-500 font-bold flex items-center">已儲存 ✓</span>}
                        </div>
                    </div>
                </div>

                <div className="doodle-card p-5 bg-white border-4 border-red-100">
                    <h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="Save" className="w-8 h-8 text-red-500"/> 資料備份與管理</h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onClick={handleBackupData} className="btn-3d bg-green-500 text-white flex items-center justify-center gap-2 text-xl font-bold h-20 rounded-xl">
                            <Icon name="Download" className="w-8 h-8"/> 備份資料 (下載)
                        </button>
                        <button onClick={() => backupInputRef.current.click()} className="btn-3d bg-blue-500 text-white flex items-center justify-center gap-2 text-xl font-bold h-20 rounded-xl">
                            <Icon name="RefreshCw" className="w-8 h-8"/> 還原資料 (上傳)
                        </button>
                        <input type="file" ref={backupInputRef} onChange={handleRestoreData} style={{display:'none'}} accept=".json" />
                        
                        <button onClick={handleResetData} className="btn-3d bg-red-500 text-white flex items-center justify-center gap-2 text-xl font-bold h-20 md:col-span-2 border-red-800 rounded-xl">
                            <Icon name="Trash" className="w-8 h-8"/> 重置所有資料 (清除)
                        </button>
                    </div>
                </div>

                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="UserCog" className="w-8 h-8"/> 學生名單管理</h3>
                  <div className="mb-6">
                    <div className="flex gap-2 mb-3">
                      <input type="file" ref={fileInputRef} onChange={(e) => { if(e.target.files[0]) processFile(e.target.files[0]); }} style={{display:'none'}} accept=".xlsx,.xls,.docx,image/*" />
                      <button onClick={() => fileInputRef.current.click()} className="btn-3d bg-white border-2 border-coffee py-4 px-6 flex items-center gap-2 text-coffee font-bold text-lg h-16 w-full justify-center" disabled={isProcessing}>
                        {isProcessing ? '處理中...' : <><Icon name="Upload" className="w-6 h-6"/> 選擇檔案 (Excel/Word/圖)</>}
                      </button>
                    </div>
                    <textarea className="input-hand h-40 text-lg" placeholder="解析結果會出現在這..." value={bulkNamesInput} onChange={(e) => setBulkNamesInput(e.target.value)} />
                    <button onClick={handleBulkImportNames} className="mt-4 w-full btn-3d bg-yellow py-3 text-coffee text-xl font-bold h-16"><Icon name="Download" className="w-6 h-6 mr-2"/> 匯入名單</button>
                  </div>
                  <div className="max-h-60 overflow-y-auto border-t-2 border-coffee pt-4">{students.map(s => (<div key={s.id} className="flex items-center gap-2 mb-3"><span className="font-bold w-12 text-lg">#{s.id}</span><input type="text" value={s.name} onChange={(e) => handleUpdateStudentName(s.id, e.target.value)} className="input-hand py-2 text-lg" /></div>))}</div>
                </div> 
                
                <div className="doodle-card p-5 bg-white"><h3 className="text-2xl font-bold mb-4 flex items-center gap-2 border-b-2 border-coffee pb-3"><Icon name="BookOpen" className="w-8 h-8"/> 科目管理</h3>
                    <div className="flex gap-2 mb-4">
                        <input type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg" placeholder="輸入新科目名稱..." />
                        <button onClick={handleAddSubject} className="btn-3d bg-coffee text-white px-4 shrink-0 flex items-center gap-1"><Icon name="Plus" className="w-5 h-5"/><span>新增</span></button>
                    </div>
                    <div className="flex flex-wrap gap-3">{subjects.map(s => (
                        <button key={s.id} onClick={(e) => { e.stopPropagation(); }} className="bg-gray-100 border-2 border-coffee px-3 py-2 rounded-full text-lg flex items-center gap-2 cursor-default">
                            {s.label}
                            <span onClick={(e) => handleDeleteSubject(s.id, e)} className="ml-2 text-gray-400 hover:text-red-500 cursor-pointer p-1"><Icon name="X" className="w-5 h-5"/></span>
                        </button>
                    ))}</div>
                </div> 
              </div> 
            );
          
            const renderBasicInfo = () => ( 
              <div className="space-y-6 pb-24"> 
                <div className="doodle-card p-5 bg-white"> 
                  <div className="flex flex-wrap md:flex-nowrap gap-3 items-end"> 
                    <div className="flex-grow"> <label className="text-base font-bold opacity-70 block mb-1">📅 日期</label> <input type="date" value={currentDate} onChange={e => setCurrentDate(e.target.value)} className="input-hand text-lg w-full" /> </div> 
                    <div className="w-1/3 md:w-auto"> <label className="text-base font-bold opacity-70 block mb-1">🗓️ 週次</label> <select value={week} onChange={e => setWeek(e.target.value)} className="input-hand text-center text-lg h-[50px] bg-white w-full"> {Array.from({length: 22}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n}</option>)} </select> </div> 
                    <div className="w-1/2 md:w-auto flex-grow md:flex-grow-0"> <label className="text-base font-bold opacity-70 block mb-1">🎓 值日生</label> <select value={dutyStudent} onChange={e => setDutyStudent(e.target.value)} className="input-hand text-lg h-[50px] bg-white w-full md:w-[120px]"> {Array.from({length: 35}, (_, i) => i + 1).map(n => <option key={n} value={n}>{n} 號</option>)} </select> </div> 
                  </div> 
                </div> 
                <div className="doodle-card p-5 bg-white relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-4 bg-mint border-b-2 border-coffee"></div><h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Icon name="Clock" className="w-7 h-7" /> 到校狀況</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-4">{ATTENDANCE_TYPES.map(type => { const count = attendanceData[type.id]?.length || 0; return <button key={type.id} onClick={() => handleAttendanceClick(type.id)} className={`btn-3d p-3 flex items-center justify-between px-4 ${type.color} text-lg h-14`}><div className="flex items-center gap-2"><Icon name={type.icon} className="w-5 h-5" /><span>{type.label}</span></div>{count > 0 && <span className="bg-coffee text-white text-sm px-3 py-1 rounded-full">{count}</span>}</button> })}</div></div> <div className="doodle-card p-5 bg-white relative overflow-hidden"> <div className="absolute top-0 left-0 w-full h-4 bg-yellow border-b-2 border-coffee"></div> <h3 className="text-2xl font-bold mb-5 mt-3 flex items-center gap-2"><Icon name="FileWarning" className="w-7 h-7" /> 作業與聯絡簿</h3> 
                <div className="grid grid-cols-3 gap-2 mb-4">
                    {CONTACT_BOOK_TYPES.map(item => (
                        <button key={item.id} onClick={() => openSelector('missing', item.id)} className={`btn-3d flex flex-col items-center justify-center p-2 h-24 ${item.color} relative`}>
                            <Icon name={item.icon} className="w-6 h-6 mb-1"/>
                            <span className="text-sm text-center leading-tight w-full break-words px-1" style={{fontSize: '0.9rem'}}>{item.label}</span>
                            {missingData[item.id]?.length > 0 && <span className="absolute top-[-5px] right-[-5px] w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-coffee text-xs z-10">{missingData[item.id].length}</span>}
                        </button>
                    ))}
                </div> 
                <div className="border-t-2 border-coffee pt-4 space-y-4"> <div className="flex justify-between items-center"><h4 className="font-bold text-coffee opacity-80 text-lg">各科作業缺交</h4><button onClick={() => setIsAddingSubject(!isAddingSubject)} className="text-sm bg-mint px-3 py-1 rounded-full border-2 border-coffee hover:bg-green-200"><Icon name="Plus" className="w-4 h-4" /></button></div> {isAddingSubject && <div className="flex gap-2"><input autoFocus type="text" value={newSubjectName} onChange={e => setNewSubjectName(e.target.value)} className="input-hand text-lg py-2" /><button onClick={handleAddSubject} className="btn-3d px-4 bg-coffee text-white text-lg">OK</button></div>} {subjects.length > 0 ? ( <div className="space-y-3"> <div className="flex gap-2"> <select value={currentSubjectId} onChange={(e) => setCurrentSubjectId(e.target.value)} className="input-hand text-lg flex-1 bg-gray-50 font-bold border-2 border-coffee">{subjects.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select> <button onClick={(e) => handleDeleteSubject(currentSubjectId, e)} className="btn-3d bg-pink text-white px-3"><Icon name="Trash2" className="w-6 h-6"/></button> </div> <button onClick={() => openSelector('missing', currentSubjectId)} className="btn-3d w-full bg-white py-4 text-lg flex justify-between px-5 border-2 border-coffee shadow-sm group active:bg-yellow"><span className="font-bold flex items-center gap-2"><Icon name="Edit3" className="w-5 h-5"/> 登記 {subjects.find(s=>s.id===currentSubjectId)?.label} 缺交</span>{missingData[currentSubjectId]?.length > 0 ? <span className="bg-pink text-white px-3 py-1 rounded-full text-sm font-bold">{missingData[currentSubjectId].length} 人</span> : <span className="text-gray-400 text-sm">點擊登記</span>}</button> </div> ) : <div className="text-center text-gray-400 py-2">請先新增科目...</div>} <div className="flex flex-wrap gap-2 mt-2">{subjects.map(s => { const count = missingData[s.id]?.length || 0; if (count === 0) return null; return ( <button key={s.id} onClick={() => { setCurrentSubjectId(s.id); openSelector('missing', s.id); }} className="bg-white border-2 border-coffee px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2 shadow-sm hover:bg-gray-50">{s.label} <span className="bg-pink text-white px-2 rounded-full text-xs">{count}</span></button> ) })}</div> </div> </div> </div> 
            );

            const renderLog = () => (
              <div className="space-y-5 pb-24">
                <div className="doodle-card p-4 bg-white flex flex-col gap-3">
                  <div className="flex items-center gap-2">
                    <label className="font-bold text-coffee text-lg shrink-0">選擇時段：</label>
                    <select value={currentLogPeriod} onChange={(e) => setCurrentLogPeriod(e.target.value)} className="input-hand text-xl font-bold bg-yellow border-2 border-coffee py-2 flex-1">
                      {PERIODS.map(p => <option key={p.id} value={p.id}>{p.label}</option>)}
                    </select>
                  </div>
                  <div className="relative">
                    <input type="text" value={periodNotes[currentLogPeriod] || ''} onChange={(e) => updatePeriodNote(e.target.value)} placeholder={`在此輸入${PERIODS.find(p=>p.id===currentLogPeriod)?.label}的備註...`} className="input-hand text-lg bg-gray-50 pr-10" />
                    <span className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"><Icon name="PenTool" className="w-5 h-5"/></span>
                  </div>
                </div>
                <div className="flex justify-between items-center px-1">
                  <h4 className="font-bold text-coffee opacity-80 text-lg">違規項目</h4>
                  <button onClick={() => setIsEditingBehaviors(!isEditingBehaviors)} className={`px-3 py-1 rounded-full border-2 border-coffee text-sm font-bold flex items-center gap-1 ${isEditingBehaviors ? 'bg-pink text-white' : 'bg-gray-100'}`}><Icon name="Settings" className="w-4 h-4" /> {isEditingBehaviors ? '完成' : '編輯'}</button>
                </div>
                {isEditingBehaviors && <div className="doodle-card p-4 bg-yellow flex gap-3"><input type="text" value={newBehaviorName} onChange={e => setNewBehaviorName(e.target.value)} placeholder="新違規項目..." className="input-hand text-lg" /><button onClick={handleAddBehavior} className="btn-3d bg-coffee text-white px-4 shrink-0 flex items-center gap-1"><Icon name="Plus" className="w-5 h-5"/><span>新增</span></button></div>}
                
                <div className="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                  {behaviors.map(behavior => {
                    const count = classLogData[currentLogPeriod]?.[behavior.id]?.length || 0;
                    return (
                      <button key={behavior.id} onClick={() => handleBehaviorClick(behavior.id)} className={`btn-3d p-2 flex flex-col items-center gap-1 ${behavior.color} min-h-[90px] relative`}>
                        {isEditingBehaviors && <span onClick={(e) => handleDeleteBehavior(behavior.id, e)} className="absolute top-1 right-1 bg-white rounded-full p-1 border border-coffee text-red-500 z-20"><Icon name="X" className="w-4 h-4" strokeWidth={3} /></span>}
                        <Icon name={behavior.icon} className="w-6 h-6" />
                        <span className="text-sm text-center leading-tight">{behavior.label}</span>
                        {!isEditingBehaviors && count > 0 && <span className="absolute top-[-5px] right-[-5px] w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center border-2 border-coffee text-xs z-10">{count}</span>}
                      </button>
                    )
                  })}
                </div>

                <div className="mt-2 p-4 bg-white border-2 border-coffee rounded-2xl shadow-sm min-h-[80px]">
                  <p className="font-bold opacity-60 mb-2 text-sm border-b-2 border-coffee border-dashed pb-1 flex justify-between"><span>{PERIODS.find(p=>p.id===currentLogPeriod)?.label} 已紀錄：</span>{(!classLogData[currentLogPeriod] || Object.values(classLogData[currentLogPeriod]).every(arr => arr.length === 0)) && !periodNotes[currentLogPeriod] && <span className="text-gray-400 font-normal">尚無資料</span>}</p>
                  {behaviors.map(b => { const list = classLogData[currentLogPeriod]?.[b.id]; if(!list || list.length===0) return null; return ( <div key={b.id} className="flex gap-2 mb-1 text-lg"> <span className="font-bold text-coffee shrink-0">{b.label}:</span> <span className="text-gray-700">{list.map(id => students.find(s=>s.id===id)?.name || id).join('、')}</span> </div> ) })}
                  {periodNotes[currentLogPeriod] && (<div className="flex gap-2 mt-2 text-lg text-blue-600 bg-blue-50 p-2 rounded-lg"><span className="font-bold shrink-0 flex items-center"><Icon name="PenTool" className="w-4 h-4 mr-1"/>備註:</span><span>{periodNotes[currentLogPeriod]}</span></div>)}
                </div>
                <div className="doodle-card p-5 bg-white mt-8"><h3 className="text-2xl font-bold mb-3 flex items-center gap-2"><Icon name="MessageCircle" className="w-7 h-7" /> 全日偶發/總結</h3><textarea value={incidentLog} onChange={(e) => setIncidentLog(e.target.value)} className="w-full h-32 p-4 border-2 border-coffee rounded-xl outline-none font-bold resize-none bg-gray-50 text-lg" placeholder="今日其他補充..." /><div className="flex justify-end mt-2"><button onClick={handleAiPolishLog} className="btn-3d bg-purple-soft text-coffee px-3 py-2 text-sm flex gap-1"><Icon name="Sparkles" className="w-4 h-4"/>AI 修飾文句</button></div></div>
              </div>
            );

            const renderReview = () => {
              const dailyStudentViolations = getDailyStudentViolations();
              const hasViolations = Object.keys(dailyStudentViolations).length > 0;
              return (
                <div className="pb-24 space-y-5">
                  <div className="flex flex-col gap-2 md:flex-row md:justify-between md:items-center">
                      <input type="date" value={currentDate} onChange={(e) => setCurrentDate(e.target.value)} className="input-hand text-lg font-bold bg-white" />
                      <button onClick={exportDailyLog} className="btn-3d bg-yellow px-5 py-3 flex items-center justify-center gap-2 text-coffee font-bold text-lg"><Icon name="FileSpreadsheet" className="w-6 h-6"/> 匯出今日日誌</button>
                  </div>
                  <div className="bg-white border-2 border-coffee p-6 min-h-[500px] text-base font-mono shadow-xl relative leading-relaxed">
                    <h2 className="text-center text-2xl font-bold mb-6 border-b-2 border-coffee pb-3">{week || '____'}週 班級日誌 ({currentDate})</h2>
                    <div className="mb-6 grid grid-cols-2 gap-4 text-lg"><div>值日生: {dutyStudent}號</div></div>
                    <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">缺勤</h3>{ATTENDANCE_TYPES.map(t => attendanceData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {attendanceData[t.id].map(id=>students.find(s=>s.id===id)?.name || id).join('、')}</div>)}</div>
                    <div className="mb-6 border border-coffee p-3"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">缺交</h3>{CONTACT_BOOK_TYPES.map(t => missingData[t.id]?.length > 0 && <div key={t.id} className="py-2 border-b border-dashed text-lg"><b>{t.label}:</b> {missingData[t.id].map(id=>students.find(s=>s.id===id)?.name || id).join('、')}</div>)}{subjects.map(s => missingData[s.id]?.length > 0 && <div key={s.id} className="py-2 border-b border-dashed text-lg"><b>{s.label}:</b> {missingData[s.id].map(id=>students.find(s=>s.id===id)?.name || id).join('、')}</div>)}</div>
                    <div className="mb-6 border border-coffee"><h3 className="font-bold bg-red-100 p-2 border-b border-coffee text-lg text-red-800 flex items-center gap-2"><Icon name="AlertTriangle" className="w-5 h-5"/> 今日違規統計 (按學生)</h3><div className="p-3 space-y-2">{hasViolations ? ( Object.entries(dailyStudentViolations).map(([studentId, violations]) => { const student = students.find(s => s.id === Number(studentId)); return ( <div key={studentId} className="border-b border-dashed last:border-0 pb-1"> <span className="font-bold text-lg text-coffee mr-2">{student?.name || `${studentId}號`}:</span> <span className="text-gray-700">{violations.join('、')}</span> </div> ); }) ) : ( <div className="text-center text-gray-400 py-2">今日無課堂違規紀錄 👍</div> )}</div></div>
                    <div className="mb-6 border border-coffee"><h3 className="font-bold bg-gray-200 p-2 border-b border-coffee text-lg">課堂異常明細 & 備註</h3>{PERIODS.map(p => { const logs=classLogData[p.id]; const note=periodNotes[p.id]; const hasLogs = logs && Object.keys(logs).some(k=>logs[k].length>0); if(!hasLogs && !note) return null; return ( <div key={p.id} className="p-3 border-b border-coffee last:border-0"> <div className="font-bold text-coffee mb-1 text-lg">{p.label}</div> {hasLogs && behaviors.map(b => logs[b.id]?.length > 0 && <div key={b.id} className="pl-4 flex text-lg"><span className="w-32 text-gray-600">- {b.label}:</span><span>{logs[b.id].map(id=>students.find(s=>s.id===id)?.name || id).join('、')}</span></div>)} {note && <div className="pl-4 text-lg text-blue-600 mt-1">備註: {note}</div>} </div> ) })}</div>
                    <div className="border border-coffee p-3 min-h-[120px]"><h3 className="font-bold mb-2 bg-gray-200 p-2 text-lg">全日偶發</h3><p className="text-lg">{incidentLog}</p></div>
                  </div>
                </div>
              );
            };

            const renderReports = () => {
              const s = students.find(stud => stud.id === selectedStudentReport);
              const hasStudent = !!s;
              const statsData = hasStudent ? getWeeklyStats(selectedStudentReport) : { stats: { attendance: {}, missing: {}, behavior: {} }, detailedBehaviors: [], detailedAttendance: [], detailedMissing: [] };

              return (
                <div className="pb-24 space-y-6">
                   <div className="doodle-card p-4 bg-white border-4 border-blue-soft relative">
                       <h3 className="font-bold mb-2 text-xl flex items-center gap-2 text-blue-600 relative z-10">
                           <div className="animate-wiggle"><Icon name="CuteBear" className="w-16 h-16 text-coffee"/></div>
                           重要事項!! (老師的話)
                       </h3>
                       <textarea value={teacherNote} onChange={(e) => setTeacherNote(e.target.value)} className="w-full h-24 p-3 border-2 border-blue-200 rounded-xl outline-none text-lg bg-blue-50" placeholder="例如：明天記得穿班服、下週一期中考..."/>
                   </div>
                   <div className="doodle-card p-5 bg-yellow flex items-center justify-between"><div className="flex items-center gap-3"><Icon name="User" className="w-9 h-9" /><div><div className="text-sm opacity-60 font-bold">查看學生</div><select value={selectedStudentReport} onChange={(e) => setSelectedStudentReport(Number(e.target.value))} className="bg-transparent text-2xl font-bold outline-none border-b-2 border-coffee min-w-[140px] py-1">{students.map(s => <option key={s.id} value={s.id}>{s.id}. {s.name}</option>)}</select></div></div><div className="text-right text-sm font-bold opacity-60">統計範圍<br/>過去 5 天</div></div>
                   {hasStudent ? (
                       <>
                           <div className="grid grid-cols-2 gap-4"><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-coffee">{Object.values(statsData.stats.attendance).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">本週缺勤</div></div><div className="doodle-card p-4 bg-white flex flex-col items-center justify-center min-h-[120px]"><div className="text-5xl font-bold text-pink-500">{Object.values(statsData.stats.missing).reduce((a,b)=>a+b, 0)}</div><div className="text-sm font-bold opacity-60 mt-1">本週缺交</div></div></div>
                           <div className="space-y-4">
                             <div className="relative"> <textarea className="input-hand w-full h-64 p-4 text-lg leading-relaxed shadow-inner resize-none" value={finalReportText} onChange={(e) => setFinalReportText(e.target.value)} /> {isAiProcessing && <div className="absolute inset-0 bg-white/80 flex items-center justify-center font-bold text-coffee">🤖 AI 正在撰寫中...</div>} </div>
                             <div className="flex justify-end"> <button onClick={handleAiGenerateReport} disabled={isAiProcessing} className="btn-3d bg-purple-soft text-coffee py-2 px-4 text-base flex items-center gap-2"> <Icon name="Sparkles" className="w-5 h-5"/> {isAiProcessing ? '撰寫中...' : 'AI 自動撰寫週報'} </button> </div>
                             <div className="flex gap-3 items-stretch"> <button onClick={() => handleLineShare(finalReportText)} className="flex-[3] btn-3d bg-line py-4 text-xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform"> <Icon name="Send" className="w-6 h-6" /> 傳送/複製訊息給家長 </button> <button onClick={() => copyToClipboard(finalReportText)} className="flex-1 btn-3d bg-mint py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="僅複製文字"> <Icon name="ClipboardCopy" className="w-6 h-6" /> <span>複製</span> </button> <button onClick={exportStudentWeekly} className="flex-1 btn-3d bg-gray-100 py-4 flex flex-col items-center justify-center gap-1 text-xs opacity-80" title="下載 Excel"> <Icon name="Download" className="w-6 h-6" /> <span>下載</span> </button> </div>
                           </div>
                       </>
                   ) : ( <div className="p-8 text-center text-gray-500 font-bold text-xl mt-10">請先從上方選單選擇一位學生</div> )}
                   
                   <div className="pt-4 border-t-4 border-dashed border-coffee opacity-60 space-y-3">
                      <button onClick={handlePrintAllStudents} className="w-full py-3 text-coffee bg-white border-2 border-coffee rounded-xl flex items-center justify-center gap-2 font-bold hover:bg-gray-50 transition"><Icon name="Printer" className="w-5 h-5"/> 列印全班週報 (6人/頁)</button>
                      <button onClick={exportWholeClassWeekly} className="w-full py-3 text-coffee flex items-center justify-center gap-2 font-bold hover:bg-orange-100 rounded-xl transition"><Icon name="FileSpreadsheet" className="w-5 h-5"/> 下載全班週報表 (Excel)</button>
                   </div>

                   <div className="doodle-card p-5 bg-white border-4 border-green-200 mt-6">
                      <h3 className="font-bold mb-4 text-xl flex items-center gap-2 text-green-700"> <Icon name="FileSpreadsheet" className="w-6 h-6"/> 學期/區間統計 </h3>
                      <div className="grid grid-cols-2 gap-4 mb-4"> <div> <label className="block text-sm font-bold opacity-70 mb-1">開始日期</label> <input type="date" value={rangeStartDate} onChange={e => setRangeStartDate(e.target.value)} className="input-hand w-full text-lg"/> </div> <div> <label className="block text-sm font-bold opacity-70 mb-1">結束日期</label> <input type="date" value={rangeEndDate} onChange={e => setRangeEndDate(e.target.value)} className="input-hand w-full text-lg"/> </div> </div>
                      <button onClick={exportRangeCSV} className="w-full btn-3d bg-green-500 text-white py-3 text-lg flex items-center justify-center gap-2"> <Icon name="Download" className="w-6 h-6"/> 匯出區間統計 Excel </button>
                      <p className="text-sm text-gray-400 mt-2 text-center">可匯出全班這段期間的缺勤、缺交、違規總表，方便打平成績。</p>
                   </div>
                </div>
              );
            };

            return (
              <div className="min-h-screen w-full max-w-4xl mx-auto relative overflow-hidden pb-10">
                <header className="pt-8 pb-3 px-6 flex justify-between items-center"><h1 className="text-4xl font-bold text-coffee tracking-wider transform -rotate-1 flex items-center gap-3"><Icon name="BookOpen" className="w-10 h-10" /> 班級小管家</h1><button onClick={() => setActiveTab('manual')} className="bg-white p-2 rounded-full border-2 border-coffee shadow-sm active:scale-95 transition" title="使用說明書"><Icon name="HelpCircle" className="w-7 h-7 text-coffee"/></button></header>
                <main className="px-5 h-full pt-4">{activeTab === 'basic' && renderBasicInfo()}{activeTab === 'log' && renderLog()}{activeTab === 'review' && renderReview()}{activeTab === 'report' && renderReports()}{activeTab === 'settings' && renderSettings()}{activeTab === 'manual' && renderManual()}</main>
                {renderStudentSelector()}
                {notification && <Toast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
                <ConfirmationModal isOpen={modalConfig.isOpen} message={modalConfig.message} onConfirm={modalConfig.onConfirm} onCancel={() => setModalConfig({ ...modalConfig, isOpen: false })} />
                <CustomPrompt isOpen={promptConfig.isOpen} title={promptConfig.title} defaultValue={promptConfig.defaultValue} onConfirm={promptConfig.onConfirm} onCancel={() => setPromptConfig(prev => ({ ...prev, isOpen: false }))} />
                
                <nav className="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[98%] max-w-xl bg-[#FFF] border-3 border-coffee rounded-2xl shadow-[4px_4px_0px_#5D4037] flex justify-between px-3 py-3 z-40">
                  {[{ id: 'basic', icon: 'User', label: '點名', color: 'bg-mint' }, { id: 'log', icon: 'Edit3', label: '紀錄', color: 'bg-yellow' }, { id: 'review', icon: 'List', label: '日誌', color: 'bg-pink' }, { id: 'report', icon: 'FileSpreadsheet', label: '報表', color: 'bg-blue-soft' }, { id: 'settings', icon: 'Settings', label: '設定', color: 'bg-red-alert' }].map(tab => ( <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 flex flex-col items-center p-2 rounded-xl transition-all duration-300 ${tab.id === 'settings' ? 'nav-btn-settings ' + (activeTab === 'settings' ? 'active' : '') : (activeTab === tab.id ? `${tab.color} -translate-y-4 border-2 border-coffee shadow-sm` : 'opacity-60')}`}><div className={tab.id === 'settings' ? 'text-white' : 'text-coffee'}><Icon name={tab.icon} className="w-8 h-8"/></div><span className={`text-xs font-black mt-1 ${tab.id === 'settings' ? 'text-white' : 'text-coffee'}`}>{tab.label}</span></button> ))}
                </nav>
              </div>
            );
        }

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<ClassManagerLine />);
            setTimeout(() => {
                const loading = document.getElementById('loading-screen');
                if(loading && loading.style.display !== 'none') {
                    loading.style.opacity = '0';
                    setTimeout(() => loading.style.display = 'none', 500);
                }
            }, 500);
        } catch (err) {
            console.error(err);
            document.getElementById('root').innerHTML = `<div style="padding:20px; color:red; font-weight:bold;">啟動失敗: ${err.message}</div>`;
        }
    </script>
</body>
</html>


